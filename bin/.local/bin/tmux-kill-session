#!/usr/bin/env bash
# Kill tmux sessions with FZF - optimized for popup

# Check if tmux is running
if ! tmux list-sessions &>/dev/null; then
    echo "No tmux sessions running"
    read -p "Press any key to close..." -n 1
    exit 0
fi

# Get current session if inside tmux
if [[ -n $TMUX ]]; then
    current=$(tmux display-message -p '#S')
else
    current=""
fi

# List all sessions, excluding current if inside tmux
if [[ -n $current ]]; then
    sessions=$(tmux list-sessions -F '#{session_name}' | grep -v "^$current$")
else
    sessions=$(tmux list-sessions -F '#{session_name}')
fi

# Check if there are sessions to kill
if [[ -z $sessions ]]; then
    if [[ -n $current ]]; then
        echo "No other sessions to kill (current: $current)"
    else
        echo "No sessions available"
    fi
    read -p "Press any key to close..." -n 1
    exit 0
fi

# FZF selection with preview - optimized for popup
selected=$(echo "$sessions" | \
    fzf --multi \
        --reverse \
        --height 100% \
        --border \
        --bind start:top \
        --prompt "Kill session(s): " \
        --header "TAB=select multiple | ENTER=kill | ESC=cancel | Current: ${current:-none}" \
        --preview 'tmux list-windows -t {} -F "  #{window_index}:#{window_name} - #{pane_current_command}"' \
        --preview-window right:50% \
        --bind 'ctrl-a:select-all' \
        --bind 'ctrl-d:deselect-all')

# Kill selected sessions
if [[ -n $selected ]]; then
    echo ""
    echo "Killing sessions..."
    echo "$selected" | while IFS= read -r session; do
        tmux kill-session -t "$session"
        echo "  ✓ Killed: $session"
    done
    
    # Force resurrect save
    echo ""
    echo "Saving state to resurrect..."
    if [[ -n $TMUX ]]; then
        tmux run-shell ~/.tmux/plugins/tmux-resurrect/scripts/save.sh 2>/dev/null
    fi
    
    echo ""
    echo "✓ Done! Deleted $(echo "$selected" | wc -l) session(s)"
    echo ""
    read -p "Press any key to close..." -n 1
else
    echo "Cancelled - no sessions killed"
    read -p "Press any key to close..." -n 1
fi
