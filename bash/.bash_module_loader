# ============================================================================
# MODULE LOADER
# ============================================================================

# Create a flag file to control which modules to load
BASHRC_MODULES_FILE="$HOME/.bashrc_modules"

# Initialize with all modules enabled if file doesn't exist
if [[ ! -f "$BASHRC_MODULES_FILE" ]]; then
    cat > "$BASHRC_MODULES_FILE" << 'EOF'
# List modules to load (one per line)
# Comment out with # to disable
android
dotnet
EOF
fi

# Function to source module files
source_module() {
    local module="$1"
    local module_file="$HOME/.bashrc.d/${module}.bash"
    
    if [[ -f "$module_file" ]]; then
        source "$module_file"
        echo "✓ Loaded: $module" >&2
    else
        echo "✗ Module not found: $module_file" >&2
    fi
}

# Load enabled modules
while IFS= read -r module; do
    # Skip empty lines and comments
    [[ -z "$module" || "$module" =~ ^[[:space:]]*# ]] && continue
    source_module "$module"
done < "$BASHRC_MODULES_FILE"

# Helper functions to manage modules
bash_enable_module() {
    local module="$1"
    if [[ -z "$module" ]]; then
        echo "Usage: bash_enable_module <module_name>"
        return 1
    fi
    
    # Check if already enabled
    if grep -q "^${module}$" "$BASHRC_MODULES_FILE" 2>/dev/null; then
        echo "Module '$module' is already enabled"
        return 0
    fi
    
    # Add to file
    echo "$module" >> "$BASHRC_MODULES_FILE"
    echo "Module '$module' enabled. Restart shell or run: source ~/.bashrc"
}

bash_disable_module() {
    local module="$1"
    if [[ -z "$module" ]]; then
        echo "Usage: bash_disable_module <module_name>"
        return 1
    fi
    
    # Comment out the module
    sed -i "s/^${module}$/# ${module}/" "$BASHRC_MODULES_FILE"
    echo "Module '$module' disabled. Restart shell or run: source ~/.bashrc"
}

bash_list_modules() {
    echo "Available modules in ~/.bashrc.d/:"
    if [[ -d "$HOME/.bashrc.d" ]]; then
        for f in "$HOME/.bashrc.d"/*.bash; do
            [[ -f "$f" ]] && basename "$f" .bash
        done
    fi
    
    echo ""
    echo "Currently configured (in ~/.bashrc_modules):"
    cat "$BASHRC_MODULES_FILE" 2>/dev/null || echo "No configuration found"
}

